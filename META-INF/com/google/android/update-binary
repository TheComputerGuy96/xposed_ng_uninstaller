#!/sbin/sh
# 
##########################################################################################
# 
# Magisk
# by topjohnwu
# 
# This is a Magisk Module Uninstaller ZIP for Developers
# By Dark1
# Profile :
# https://forum.xda-developers.com/member.php?u=7292542
# https://github.com/dark-1
# 
# This script removes the Magisk Module files.
# 
# DO Not Touch this Script Unless Necessary.
# 
##########################################################################################

# Detect whether in boot mode
ps | grep zygote | grep -v grep >/dev/null && BOOTMODE=true || BOOTMODE=false
$BOOTMODE || ps -A 2>/dev/null | grep zygote | grep -v grep >/dev/null && BOOTMODE=true

# This path should work in any cases
TMPDIR=/dev/tmp
MOUNTPATH=/magisk
IMG=/data/magisk.img
if $BOOTMODE; then
  MOUNTPATH=/dev/magisk_merge
  IMG=/data/magisk_merge.img
fi
UNINSTALLER=$TMPDIR/uninstall
MAGISKBIN=/data/magisk

# Default permissions
umask 022

##########################################################################################
# Flashable update-binary preparation
##########################################################################################

OUTFD=$2
ZIP=$3

ui_print() {
  if $BOOTMODE; then
    echo "$1"
  else 
    echo -n -e "ui_print $1\n" >> /proc/self/fd/$OUTFD
    echo -n -e "ui_print\n" >> /proc/self/fd/$OUTFD
  fi
}

require_new_magisk() {
  ui_print "***********************************"
  ui_print "! $MAGISKBIN isn't setup properly!"
  ui_print "! Please install Magisk v13.1+!"
  ui_print "***********************************"
  exit 1
}

# Mount /data to access MAGISKBIN
mount /data 2>/dev/null

# MAGISKBIN must exist, binaries and utility functions are placed there
[ -d $MAGISKBIN -a -f $MAGISKBIN/magisk -a -f $MAGISKBIN/util_functions.sh ] || require_new_magisk

# Load utility fuctions
. $MAGISKBIN/util_functions.sh
[ ! -z $SCRIPT_VERSION -a $SCRIPT_VERSION -ge 1310 ] || require_new_magisk
get_outfd

# Dummy MODID
MODID=UnInstall

# Dummy print_modname() Fn
print_modname()
{
  # print_modname() Fn
  ui_print "*******************************"
  ui_print "   Magisk Module Uninstaller   "
  ui_print "*******************************"
}

# Dummy script_before_uninstall() Fn
script_before_uninstall()
{
  # script_before_uninstall() Fn
}

# Dummy script_after_uninstall() Fn
script_after_uninstall()
{
  # script_after_uninstall() Fn
}

rm -rf $TMPDIR 2>/dev/null
mkdir -p $UNINSTALLER
unzip -o "$ZIP" config.sh -d $UNINSTALLER 2>/dev/null

##########################################################################################
# Prepare
##########################################################################################

[ ! -f $UNINSTALLER/config.sh ] && abort "! Unable to extract zip file!"

. $UNINSTALLER/config.sh

MODPATH=$MOUNTPATH/$MODID

ui_print " "
# Print MOD name
print_modname
ui_print " "
# Please leave this message in your flashable zip for credits :)
ui_print "*******************************"
ui_print " Magisk Module Uninstaller ZIP "
ui_print " By Dark1                      "
ui_print "*******************************"
ui_print " "
ui_print "*******************************"
ui_print " Powered by Magisk (@topjohnwu)"
ui_print "*******************************"
ui_print " "
ui_print "!!!*************************!!!"
ui_print "! Removing Magisk Module [MODID] : $MODID !"
ui_print "!!!*************************!!!"
ui_print " "

ui_print "- Mounting /system, /vendor, /data, /cache"
mount -o ro /system 2>/dev/null
mount -o ro /vendor 2>/dev/null
mount /data 2>/dev/null
mount /cache 2>/dev/null

[ ! -f /data/magisk.img ] && abort "! Magisk is not installed"
$BOOTMODE && ! is_mounted /magisk && abort "! Magisk is not activated!"

##########################################################################################
# UnInstall
##########################################################################################

ui_print "- Mounting $IMG to $MOUNTPATH"
MAGISKLOOP=`$MAGISKBIN/magisk --mountimg $IMG $MOUNTPATH`
is_mounted $MOUNTPATH || abort "! $IMG mount failed..."

# Execute script_before_uninstall() Fn
script_before_uninstall

# UnInstall Magisk Module
if is_mounted $MODPATH; then
  rm -rf $MODPATH 2>/dev/null
  ui_print "- Removed Magisk Module : \"$MODID\" !"
fi

# Execute script_after_uninstall() Fn
script_after_uninstall

##########################################################################################
# Finalizing
##########################################################################################

$MAGISKBIN/magisk --umountimg $MOUNTPATH $MAGISKLOOP
rmdir $MOUNTPATH

# Shrink the image if possible
image_size_check $IMG
newSizeM=$((curUsedM / 32 * 32 + 64))
if [ $curSizeM -gt $newSizeM ]; then
  ui_print "- Shrinking $IMG to ${newSizeM}M"
  $MAGISKBIN/magisk --resizeimg $IMG $newSizeM
fi

$BOOTMODE || recovery_cleanup

ui_print "- Done"
exit 0
